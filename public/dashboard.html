<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Girish Cable - Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin:0; display:flex; height:100vh; background:#f4f4f4;}
.sidebar { width:220px; background:#1e2a38; color:#fff; display:flex; flex-direction:column; padding:10px; }
.sidebar .brand { font-size:1.5em; margin-bottom:20px; text-align:center; }
.nav-btn { background:none; border:none; color:#fff; padding:12px; width:100%; text-align:left; cursor:pointer; margin-bottom:5px; font-size:1em; border-radius:5px; }
.nav-btn:hover { background:#34495e; }
.nav-btn.danger { margin-top:auto; background:#c0392b; }
.content { flex:1; padding:20px; overflow:auto; }
.section { display:none; }
.section.active { display:block; }
.section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
table { width:100%; border-collapse: collapse; margin-bottom:20px; background:#fff; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
button { cursor:pointer; padding:5px 10px; margin:2px; border-radius:4px; }
button.danger { background:#e74c3c; color:#fff; border:none; }
input, select { width:100%; padding:5px; margin:5px 0; box-sizing:border-box; border-radius:4px; border:1px solid #ccc; }
input[readonly]{background:#eee;}
.modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000; }
.modal.hidden { display:none; }
.modal-body { background:#fff; padding:20px; width:95%; max-width:900px; border-radius:5px; max-height:90vh; overflow:auto;}
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
#searchBox { width:100%; padding:8px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; }
.summary { display:flex; gap:20px; margin-bottom:20px; }
.card { background:#3498db; color:#fff; padding:15px; border-radius:8px; flex:1; text-align:center; }
.card h3 { margin:0 0 5px; }
.paid { background-color:#2ecc71; color:#fff; }
.unpaid { background-color:#e74c3c; color:#fff; }
@media(max-width:768px){ body{flex-direction:column;} .sidebar{width:100%; flex-direction:row; overflow-x:auto;} .sidebar .brand{flex:none;} .nav-btn{flex:none;} .content{padding:10px;} .summary{flex-direction:column;} table, th, td{ font-size:12px;} }
</style>
</head>
<body>

<aside class="sidebar">
  <div class="brand">Girish Cable</div>
  <nav>
    <button class="nav-btn" onclick="showSection('summary')">Summary</button>
    <button class="nav-btn" onclick="showSection('customers')">Customers</button>
    <button class="nav-btn" onclick="showSection('plans')">Plans</button>
    <button class="nav-btn" onclick="openChangePasswordModal()">Change Password</button>
  </nav>
  <div class="spacer"></div>
  <button class="nav-btn danger" onclick="logout()">Logout</button>
</aside>

<main class="content">
  <section id="summary" class="section active">
    <div class="summary">
      <div class="card"><h3>This Month</h3><div id="totalMonth">₹0</div></div>
      <div class="card"><h3>This Year</h3><div id="totalYear">₹0</div></div>
      <div class="card"><h3>Pending</h3><div id="totalPending">₹0</div></div>
    </div>
  </section>

  <input type="text" id="searchBox" placeholder="Search customers..." onkeyup="searchCustomer()">

  <section id="customers" class="section">
    <div class="section-header">
      <h2>Customers</h2>
      <button onclick="openCustomerForm()">+ Add Customer</button>
    </div>
    <table id="customersTable">
      <thead><tr><th>ID</th><th>Name</th><th>Village</th><th>Phone</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="plans" class="section">
    <div class="section-header">
      <h2>Plans</h2>
      <button onclick="openPlanForm()">+ Add Plan</button>
    </div>
    <table id="plansTable">
      <thead><tr><th>ID</th><th>Name</th><th>Price</th><th>Description</th><th>Actions</th></tr></thead>
    </table>
  </section>
</main>

<div id="modal" class="modal hidden">
  <div class="modal-body">
    <div class="modal-header">
      <h3 id="modalTitle">Modal</h3>
      <button onclick="closeModal()">×</button>
    </div>
    <div id="modalContent"></div>
  </div>
</div>

<script>
// Common functions
function logout(){ localStorage.removeItem('gc_user'); location.href='login.html'; }
function showSection(id){ document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function openModal(){ document.getElementById('modal').classList.remove('hidden'); }
function closeModal(){ document.getElementById('modal').classList.add('hidden'); }
function escapeHtml(text){ return text.replace(/'/g,"&apos;").replace(/"/g,"&quot;"); }

// Summary
async function loadSummary(){
  const customers = JSON.parse(localStorage.getItem('customers') || '[]');
  const payments = JSON.parse(localStorage.getItem('payments') || '[]');
  const thisYear = new Date().getFullYear();
  const thisMonth = new Date().getMonth() + 1;
  let monthTotal = 0, yearTotal = 0, pending = 0;
  customers.forEach(c => {
    payments.forEach(p => {
      if(p.customer_id === c.id){
        if(p.year === thisYear){
          yearTotal += p.amount;
          if(p.status === 'unpaid') pending += p.amount;
          if(p.month === thisMonth) monthTotal += p.amount;
        }
      }
    });
  });
  document.getElementById('totalMonth').innerText = `₹${monthTotal}`;
  document.getElementById('totalYear').innerText = `₹${yearTotal}`;
  document.getElementById('totalPending').innerText = `₹${pending}`;
}

// Customers
async function loadCustomers() {
  const data = JSON.parse(localStorage.getItem('customers') || '[]');
  const tbody = document.querySelector('#customersTable tbody');
  tbody.innerHTML = '';
  data.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.vc_no || ''}</td>
      <td>${c.name}</td>
      <td>${c.village}</td>
      <td>${c.phone}</td>
      <td>
        <button onclick="editCustomer(${c.id}, '${escapeHtml(c.vc_no || '')}', '${escapeHtml(c.name)}', '${escapeHtml(c.village)}', '${escapeHtml(c.phone)}')">Edit</button>
        <button onclick="viewPayments(${c.id}, '${escapeHtml(c.vc_no || '')}', '${escapeHtml(c.name)}')">Payments</button>
        <button class="danger" onclick="deleteCustomer(${c.id})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function openCustomerForm() {
  document.getElementById('modalTitle').innerText = 'Add Customer';
  document.getElementById('modalContent').innerHTML = `
    <label>ID</label><input id="c_id" type="number" placeholder="Leave empty for auto"/>
    <label>VC No</label><input id="c_vcno" type="text" placeholder="Leave empty for auto"/>
    <label>Name</label><input id="c_name"/>
    <label>Village</label><input id="c_village"/>
    <label>Phone</label><input id="c_phone"/>
    <button onclick="createCustomer()">Save</button>`;
  openModal();
}

function createCustomer() {
  const idField = document.getElementById('c_id').value.trim();
  const vcField = document.getElementById('c_vcno').value.trim();
  const id = idField !== '' ? parseInt(idField) : Date.now();
  const vc_no = vcField !== '' ? vcField : 'VC-' + Date.now();
  const name = document.getElementById('c_name').value.trim();
  const village = document.getElementById('c_village').value.trim();
  const phone = document.getElementById('c_phone').value.trim();

  if (!name || !village || !phone) {
    alert('All fields except ID and VC No are required');
    return;
  }

  let customers = JSON.parse(localStorage.getItem('customers') || '[]');
  customers.push({ id, vc_no, name, village, phone });
  localStorage.setItem('customers', JSON.stringify(customers));
  closeModal();
  loadCustomers();
  loadSummary();
}

function editCustomer(id, vc_no, name, village, phone) {
  document.getElementById('modalTitle').innerText = 'Edit Customer';
  document.getElementById('modalContent').innerHTML = `
    <label>VC No</label><input id="e_vcno" value="${vc_no}"/>
    <label>Name</label><input id="e_name" value="${name}"/>
    <label>Village</label><input id="e_village" value="${village}"/>
    <label>Phone</label><input id="e_phone" value="${phone}"/>
    <button onclick="updateCustomer(${id})">Update</button>`;
  openModal();
}

function updateCustomer(id) {
  const vc_no = document.getElementById('e_vcno').value.trim();
  const name = document.getElementById('e_name').value.trim();
  const village = document.getElementById('e_village').value.trim();
  const phone = document.getElementById('e_phone').value.trim();

  if (!name || !village || !phone) {
    alert('Fields cannot be empty');
    return;
  }

  let customers = JSON.parse(localStorage.getItem('customers') || '[]');
  let customer = customers.find(c => c.id === id);
  if (customer) {
    customer.vc_no = vc_no;
    customer.name = name;
    customer.village = village;
    customer.phone = phone;
    localStorage.setItem('customers', JSON.stringify(customers));
    closeModal();
    loadCustomers();
  }
}

function deleteCustomer(id) {
  if (!confirm('Delete this customer?')) return;
  let customers = JSON.parse(localStorage.getItem('customers') || '[]');
  customers = customers.filter(c => c.id !== id);
  localStorage.setItem('customers', JSON.stringify(customers));
  loadCustomers();
  loadSummary();
}

function searchCustomer() {
  const q = document.getElementById('searchBox').value.toLowerCase();
  let customers = JSON.parse(localStorage.getItem('customers') || '[]');
  customers = customers.filter(c =>
    c.name.toLowerCase().includes(q) ||
    c.village.toLowerCase().includes(q) ||
    c.phone.includes(q) ||
    (c.vc_no && c.vc_no.toLowerCase().includes(q))
  );
  populateCustomersTable(customers);
}

function populateCustomersTable(data) {
  const tbody = document.querySelector('#customersTable tbody');
  tbody.innerHTML = '';
  data.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.vc_no || ''}</td>
      <td>${c.name}</td>
      <td>${c.village}</td>
      <td>${c.phone}</td>
      <td>
        <button onclick="editCustomer(${c.id}, '${escapeHtml(c.vc_no || '')}', '${escapeHtml(c.name)}', '${escapeHtml(c.village)}', '${escapeHtml(c.phone)}')">Edit</button>
        <button onclick="viewPayments(${c.id}, '${escapeHtml(c.vc_no || '')}', '${escapeHtml(c.name)}')">Payments</button>
        <button class="danger" onclick="deleteCustomer(${c.id})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// Utility function to escape HTML
function escapeHtml(text) {
  if (!text) return '';
  return text
    .replace(/&/g, "&amp;")
    .replace(/'/g, "&#39;")
    .replace(/"/g, "&quot;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

// Plans
async function loadPlans(){
  const data = JSON.parse(localStorage.getItem('plans') || '[]');
  const tbody = document.querySelector('#plansTable tbody');
  tbody.innerHTML = '';
  data.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>₹${p.price}</td>
      <td>${p.description||''}</td>
      <td>
        <button onclick="editPlan(${p.id},'${escapeHtml(p.name)}','${p.price}','${escapeHtml(p.description||'')}')">Edit</button>
        <button class="danger" onclick="deletePlan(${p.id})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
function openPlanForm(){
  document.getElementById('modalTitle').innerText = 'Add Plan';
  document.getElementById('modalContent').innerHTML = `
    <label>ID</label><input id="p_id" type="number" placeholder="Leave empty for auto"/>
    <label>Name</label><input id="p_name"/>
    <label>Price</label><input id="p_price" type="number"/>
    <label>Description</label><input id="p_desc"/>
    <button onclick="createPlan()">Save</button>`;
  openModal();
}
function createPlan(){
  const idField = document.getElementById('p_id').value.trim();
  const id = idField !== '' ? parseInt(idField) : Date.now();
  const name = document.getElementById('p_name').value.trim();
  const price = parseInt(document.getElementById('p_price').value);
  const description = document.getElementById('p_desc').value.trim();
  if(!name || !price){ alert('All fields required'); return; }
  let plans = JSON.parse(localStorage.getItem('plans') || '[]');
  plans.push({id,name,price,description});
  localStorage.setItem('plans', JSON.stringify(plans));
  closeModal();
  loadPlans();
}
function editPlan(id,name,price,desc){
  document.getElementById('modalTitle').innerText = 'Edit Plan';
  document.getElementById('modalContent').innerHTML = `
    <label>Name</label><input id="ep_name" value="${name}"/>
    <label>Price</label><input id="ep_price" type="number" value="${price}"/>
    <label>Description</label><input id="ep_desc" value="${desc}"/>
    <button onclick="updatePlan(${id})">Update</button>`;
  openModal();
}
function updatePlan(id){
  const name = document.getElementById('ep_name').value.trim();
  const price = parseInt(document.getElementById('ep_price').value);
  const description = document.getElementById('ep_desc').value.trim();
  if(!name || !price){ alert('Name and price required'); return; }
  let plans = JSON.parse(localStorage.getItem('plans') || '[]');
  let plan = plans.find(p=>p.id===id);
  if(plan){
    plan.name = name;
    plan.price = price;
    plan.description = description;
    localStorage.setItem('plans', JSON.stringify(plans));
    closeModal();
    loadPlans();
  }
}
function deletePlan(id){
  if(!confirm('Delete this plan?')) return;
  let plans = JSON.parse(localStorage.getItem('plans') || '[]');
  plans = plans.filter(p=>p.id !== id);
  localStorage.setItem('plans', JSON.stringify(plans));
  loadPlans();
}


// --- Payments Section ---

// Remember selected year for each customer
let paymentYearSelected = {};

// Open Payments Modal for a customer
function viewPayments(customerId, customerName){
  document.getElementById('modalTitle').innerText = `Payments - ${customerName}`;
  let html = `
    <label>Select Year:</label>
    <select id="paymentYear" onchange="changePaymentYear(${customerId})">`;
  for(let y = 2023; y <= 2050; y++){
    html += `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`;
  }
  html += `</select><br/><br/>
    <div id="paymentsTable"></div>`;
  document.getElementById('modalContent').innerHTML = html;
  openModal();
  renderPaymentsTable(customerId, new Date().getFullYear());
}

// Handle year change in payment modal
function changePaymentYear(customerId){
  const selectedYear = parseInt(document.getElementById('paymentYear').value);
  renderPaymentsTable(customerId, selectedYear);
}

// Render payment table for the selected year
function renderPaymentsTable(customerId, year){
  const payments = JSON.parse(localStorage.getItem('payments') || '[]');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  let html = `<table><tr><th>Month</th><th>Amount</th><th>Status</th><th>Mode</th><th>Action</th></tr>`;
  let totalPaid = 0;
  let totalPending = 0;

  for(let m = 1; m <= 12; m++){
    let p = payments.find(x => x.customer_id === customerId && x.year === year && x.month === m);
    let amount = p ? p.amount : 200;
    let status = p ? p.status : 'unpaid';
    let mode = p ? p.mode : 'online';
    let pid = p ? p.id : `new_${year}_${m}`;

    if(status === 'paid'){
      totalPaid += amount;
    } else {
      totalPending += amount;
    }

    html += `<tr class="${status}">
      <td>${months[m-1]}</td>
      <td><input type="number" id="amount_${pid}" value="${amount}"></td>
      <td>
        <select id="status_${pid}">
          <option value="paid" ${status === 'paid' ? 'selected' : ''}>Paid</option>
          <option value="unpaid" ${status === 'unpaid' ? 'selected' : ''}>Unpaid</option>
        </select>
      </td>
      <td>
        <select id="mode_${pid}">
          <option value="cash" ${mode === 'cash' ? 'selected' : ''}>Cash</option>
          <option value="online" ${mode === 'online' ? 'selected' : ''}>Online</option>
        </select>
      </td>
      <td>
        <button onclick="updatePaymentStatus(${customerId}, ${m}, ${year}, '${pid}')">Save</button>
      </td>
    </tr>`;
  }

  html += `<tr>
    <td colspan="5"><b>Total Paid: ₹${totalPaid} | Total Pending: ₹${totalPending}</b></td>
  </tr>`;
  html += `</table>`;
  document.getElementById('paymentsTable').innerHTML = html;
}

// Update or create a payment entry
function updatePaymentStatus(customerId, month, year, id){
  let payments = JSON.parse(localStorage.getItem('payments') || '[]');
  const status = document.getElementById(`status_${id}`).value;
  const mode = document.getElementById(`mode_${id}`).value;
  const amount = parseInt(document.getElementById(`amount_${id}`).value);

  if(id.startsWith('new_')){
    const newId = payments.length ? Math.max(...payments.map(p => p.id || 0)) + 1 : 1;
    payments.push({ id: newId, customer_id: customerId, month, year, amount, status, mode });
  } else {
    let p = payments.find(x => x.id == id);
    if(p){
      p.amount = amount;
      p.status = status;
      p.mode = mode;
    }
  }

  localStorage.setItem('payments', JSON.stringify(payments));
  renderPaymentsTable(customerId, year);
  loadSummary();
}

// Load summary totals
function loadSummary(){
  const payments = JSON.parse(localStorage.getItem('payments') || '[]');
  const thisMonth = new Date().getMonth() + 1;
  const thisYear = new Date().getFullYear();

  let totalMonth = 0;
  let totalYear = 0;
  let totalPending = 0;

  payments.forEach(p => {
    if(p.status === 'paid'){
      if(p.month === thisMonth && p.year === thisYear){
        totalMonth += p.amount;
      }
      if(p.year === thisYear){
        totalYear += p.amount;
      }
    } else {
      if(p.year === thisYear){
        totalPending += p.amount;
      }
    }
  });

  document.getElementById('totalMonth').innerText = `₹${totalMonth}`;
  document.getElementById('totalYear').innerText = `₹${totalYear}`;
  document.getElementById('totalPending').innerText = `₹${totalPending}`;
}



// Summary Loader
function loadSummary(){
  let payments = JSON.parse(localStorage.getItem('payments') || '[]');
  const currentDate = new Date();
  const month = currentDate.getMonth()+1;
  const year = currentDate.getFullYear();
  let monthTotal = 0, yearTotal = 0, pending = 0;
  payments.forEach(p=>{
    if(p.status==='paid'){
      if(p.year===year && p.month===month) monthTotal += p.amount;
      if(p.year===year) yearTotal += p.amount;
    } else {
      if(p.year===year) pending += p.amount;
    }
  });
  document.getElementById('totalMonth').innerText = `₹${monthTotal}`;
  document.getElementById('totalYear').innerText = `₹${yearTotal}`;
  document.getElementById('totalPending').innerText = `₹${pending}`;
}


// Change Password
function openChangePasswordModal(){
  document.getElementById('modalTitle').innerText = 'Change Password';
  document.getElementById('modalContent').innerHTML = `
    <label>Phone:</label><input id="cp_phone" value="9238205678" disabled/>
    <label>New Password:</label><input type="password" id="cp_new"/>
    <button onclick="changePassword()">Update</button>`;
  openModal();
}
function changePassword(){
  const phone = document.getElementById('cp_phone').value;
  const newPassword = document.getElementById('cp_new').value.trim();
  if(!newPassword){ alert('Enter new password'); return; }
  localStorage.setItem('gc_password', newPassword);
  alert('Password updated');
  closeModal();
}

// Initialize
loadCustomers();
loadPlans();
loadSummary();
</script>
</body>
</html>
